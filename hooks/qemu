#!/bin/bash
# ============================================================================
# DragonForge — Libvirt QEMU Hook for GPU Passthrough
# ============================================================================
# Safely detaches a discrete GPU from the host and binds it to vfio-pci
# for VM passthrough, then returns it to the host on VM shutdown.
#
# This hook uses device-level unbind + driver_override instead of
# kernel module unloading. This means it works even when other processes
# (like a desktop compositor or VS Code) are using the nvidia driver —
# the specific PCI device gets detached, not the entire driver stack.
#
# Install: sudo cp hooks/qemu /etc/libvirt/hooks/qemu
#          sudo chmod +x /etc/libvirt/hooks/qemu
# ============================================================================

set -euo pipefail

GUEST_NAME="$1"
HOOK_NAME="$2"
STATE_NAME="$3"

# ── Configuration ───────────────────────────────────────────────────────────
# Edit these to match your system. Run `dragonforge detect` to find them.

VM_NAME="${DRAGONFORGE_VM_NAME:-win11-dragonforge}"

# GPU PCI addresses (bus:device.function)
GPU_PCI="${DRAGONFORGE_GPU_PCI:-0000:01:00.0}"
GPU_AUDIO="${DRAGONFORGE_GPU_AUDIO:-0000:01:00.1}"

# All devices to pass through (space-separated)
DEVICES="$GPU_PCI $GPU_AUDIO"

# ── Logging ─────────────────────────────────────────────────────────────────

LOG_TAG="DragonForge"

log()  { echo "$LOG_TAG: $1"; logger -t "$LOG_TAG" "$1"; }
warn() { echo "$LOG_TAG: WARNING: $1" >&2; logger -t "$LOG_TAG" "WARNING: $1"; }
die()  { echo "$LOG_TAG: FATAL: $1" >&2; logger -t "$LOG_TAG" "FATAL: $1"; exit 1; }

# ── Guard ───────────────────────────────────────────────────────────────────
# Only act on our VM

if [ "$GUEST_NAME" != "$VM_NAME" ]; then
    exit 0
fi

# ── Helpers ─────────────────────────────────────────────────────────────────

unbind_device() {
    local dev="$1"
    if [ -e "/sys/bus/pci/devices/$dev/driver" ]; then
        local current_driver
        current_driver=$(basename "$(readlink "/sys/bus/pci/devices/$dev/driver")")
        log "Unbinding $dev from $current_driver"
        echo "$dev" > "/sys/bus/pci/devices/$dev/driver/unbind" || warn "Failed to unbind $dev"
        # Wait for unbind to complete
        local i=0
        while [ -e "/sys/bus/pci/devices/$dev/driver" ] && [ $i -lt 10 ]; do
            sleep 0.5
            i=$((i + 1))
        done
        if [ -e "/sys/bus/pci/devices/$dev/driver" ]; then
            warn "$dev still bound after 5s wait"
        fi
    else
        log "$dev has no driver bound"
    fi
}

bind_vfio() {
    local dev="$1"
    log "Binding $dev to vfio-pci"
    echo "vfio-pci" > "/sys/bus/pci/devices/$dev/driver_override"
    echo "$dev" > /sys/bus/pci/drivers/vfio-pci/bind 2>/dev/null || true
}

verify_vfio() {
    local dev="$1"
    local driver
    driver=$(basename "$(readlink "/sys/bus/pci/devices/$dev/driver" 2>/dev/null)" 2>/dev/null)
    if [ "$driver" = "vfio-pci" ]; then
        log "$dev OK — bound to vfio-pci"
        return 0
    else
        warn "$dev is on '$driver', expected vfio-pci"
        return 1
    fi
}

# ── Prepare: Detach GPU for VM ──────────────────────────────────────────────

if [ "$HOOK_NAME" = "prepare" ] && [ "$STATE_NAME" = "begin" ]; then
    log "=== Preparing GPU passthrough for $VM_NAME ==="

    # Best-effort module unload (not required for device-level passthrough)
    for mod in nvidia_drm nvidia_modeset nvidia_uvm nvidia; do
        if lsmod | grep -q "^${mod}"; then
            modprobe -r "$mod" 2>/dev/null && log "Unloaded $mod" || log "$mod in use, skipping (device-level passthrough)"
        fi
    done

    # Unbind each device from its current driver
    for dev in $DEVICES; do
        unbind_device "$dev"
    done

    # Bind each device to vfio-pci
    for dev in $DEVICES; do
        bind_vfio "$dev"
    done

    # Verify all devices are on vfio-pci
    FAILED=0
    for dev in $DEVICES; do
        verify_vfio "$dev" || FAILED=1
    done

    if [ "$FAILED" -eq 1 ]; then
        die "One or more devices failed to bind to vfio-pci. Aborting VM start."
    fi

    log "=== GPU ready for passthrough ==="

# ── Release: Return GPU to host ────────────────────────────────────────────

elif [ "$HOOK_NAME" = "release" ] && [ "$STATE_NAME" = "end" ]; then
    log "=== Returning GPU to host ==="

    # Unbind from vfio-pci
    for dev in $DEVICES; do
        unbind_device "$dev"
    done

    # Clear driver override so the original driver can reclaim
    for dev in $DEVICES; do
        echo "" > "/sys/bus/pci/devices/$dev/driver_override" 2>/dev/null || true
    done

    # Trigger PCI rescan
    log "Rescanning PCI bus"
    echo 1 > /sys/bus/pci/rescan
    sleep 2

    # Best-effort reload nvidia stack
    for mod in nvidia nvidia_modeset nvidia_uvm nvidia_drm; do
        modprobe "$mod" 2>/dev/null && log "Loaded $mod" || log "Could not load $mod"
    done

    log "=== GPU returned to host ==="
fi
