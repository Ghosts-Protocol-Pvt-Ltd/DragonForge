#!/bin/bash
# ============================================================================
# DragonForge â€” System Detection & Setup
# ============================================================================
# Detects IOMMU groups, GPU devices, and validates system readiness for
# GPU passthrough. Can also install the hook and configure VFIO.
#
# Usage:
#   ./dragonforge detect     â€” Detect GPU, IOMMU groups, system info
#   ./dragonforge setup      â€” Install hook + configure VFIO modules
#   ./dragonforge status     â€” Check current passthrough state
#   ./dragonforge vm-create  â€” Create the Windows 11 VM
#   ./dragonforge vm-start   â€” Start the VM
#   ./dragonforge vm-stop    â€” Gracefully stop the VM
#   ./dragonforge vm-kill    â€” Force stop the VM
#   ./dragonforge vm-viewer  â€” Open SPICE viewer
#   ./dragonforge uninstall  â€” Remove hook and VFIO config
# ============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"

# â”€â”€ Colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "  â•‘            ðŸ‰ DragonForge                    â•‘"
    echo "  â•‘      GPU Passthrough Toolkit                 â•‘"
    echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

info()    { echo -e "  ${BLUE}â–¸${NC} $1"; }
success() { echo -e "  ${GREEN}âœ“${NC} $1"; }
warn()    { echo -e "  ${YELLOW}âš ${NC} $1"; }
error()   { echo -e "  ${RED}âœ—${NC} $1"; }
header()  { echo -e "\n  ${BOLD}${CYAN}â”€â”€ $1 â”€â”€${NC}\n"; }

# â”€â”€ Auto-generate Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

auto_generate_config() {
    local conf="$SCRIPT_DIR/config/dragonforge.conf"

    # Already exists â€” nothing to do
    if [ -f "$conf" ]; then
        return 0
    fi

    header "Auto-generating Config"
    info "No config found â€” detecting hardware..."

    # Find first discrete NVIDIA/AMD GPU (VGA/3D controller)
    local gpu_bdf="" gpu_vendor="" gpu_device=""
    while IFS= read -r line; do
        local bdf desc
        bdf=$(echo "$line" | awk '{print $1}')
        desc=$(echo "$line" | cut -d' ' -f2-)

        if echo "$desc" | grep -qiE "nvidia|radeon|amd.*navi|amd.*vega"; then
            if echo "$desc" | grep -qiE "VGA|3D|Display"; then
                gpu_bdf="$bdf"
                # Normalize to full domain format
                if [[ ! "$gpu_bdf" =~ ^[0-9a-fA-F]{4}: ]]; then
                    gpu_bdf="0000:$gpu_bdf"
                fi
                gpu_vendor=$(cat "/sys/bus/pci/devices/$gpu_bdf/vendor" 2>/dev/null | sed 's/^0x//')
                gpu_device=$(cat "/sys/bus/pci/devices/$gpu_bdf/device" 2>/dev/null | sed 's/^0x//')
                break
            fi
        fi
    done < <(lspci -Dnn 2>/dev/null | grep -iE "VGA|3D|Display" || true)

    if [ -z "$gpu_bdf" ]; then
        error "No discrete NVIDIA/AMD GPU found"
        info "Create config/dragonforge.conf manually from the example"
        return 1
    fi

    success "Found GPU: $gpu_bdf [$gpu_vendor:$gpu_device]"

    # Find matching audio device (same bus, function .1)
    local bus_prefix="${gpu_bdf%.*}"
    local gpu_audio_bdf="${bus_prefix}.1"
    local audio_vendor="" audio_device=""
    if [ -d "/sys/bus/pci/devices/$gpu_audio_bdf" ]; then
        audio_vendor=$(cat "/sys/bus/pci/devices/$gpu_audio_bdf/vendor" 2>/dev/null | sed 's/^0x//')
        audio_device=$(cat "/sys/bus/pci/devices/$gpu_audio_bdf/device" 2>/dev/null | sed 's/^0x//')
        success "Found GPU Audio: $gpu_audio_bdf [$audio_vendor:$audio_device]"
    else
        gpu_audio_bdf=""
        warn "No GPU audio device found at ${bus_prefix}.1 â€” edit config manually"
    fi

    # Detect total RAM, allocate half for VM (rounded to nearest GB, capped at 16G min 4G)
    local total_ram_kb
    total_ram_kb=$(awk '/MemTotal/{print $2}' /proc/meminfo)
    local vm_ram_mb=$(( (total_ram_kb / 2 / 1024 / 1024) * 1024 ))  # round down to nearest GB
    if [ "$vm_ram_mb" -gt 16384 ]; then vm_ram_mb=16384; fi
    if [ "$vm_ram_mb" -lt 4096 ]; then vm_ram_mb=4096; fi

    # Detect CPU threads, allocate half for VM (min 2)
    local total_threads
    total_threads=$(nproc)
    local vm_cpus=$(( total_threads / 2 ))
    if [ "$vm_cpus" -lt 2 ]; then vm_cpus=2; fi

    # Find Windows ISO
    local win_iso=""
    for search_dir in "$HOME/Downloads" "$HOME" "/tmp"; do
        local found
        found=$(find "$search_dir" -maxdepth 2 -iname "Win11*.iso" -o -iname "Win10*.iso" 2>/dev/null | head -1)
        if [ -n "$found" ]; then
            win_iso="$found"
            break
        fi
    done

    # Find VirtIO ISO
    local virtio_iso=""
    for search_dir in "$HOME/Downloads" "$HOME" "/tmp"; do
        local found
        found=$(find "$search_dir" -maxdepth 2 -iname "virtio-win*.iso" 2>/dev/null | head -1)
        if [ -n "$found" ]; then
            virtio_iso="$found"
            break
        fi
    done

    # Write config
    mkdir -p "$SCRIPT_DIR/config"
    cat > "$conf" <<CONFEOF
# ============================================================================
# DragonForge Configuration â€” Auto-generated $(date +%Y-%m-%d)
# ============================================================================
# Edit these values if anything looks wrong.
# Run 'dragonforge detect' to see full hardware details.
# ============================================================================

# â”€â”€ VM Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

VM_NAME="win11-dragonforge"
VM_RAM_MB="$vm_ram_mb"
VM_CPUS="$vm_cpus"
VM_DISK_SIZE="128G"
VM_DISK_PATH="/var/lib/libvirt/images/win11-dragonforge.qcow2"

# â”€â”€ GPU Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

GPU_PCI="$gpu_bdf"
GPU_AUDIO="${gpu_audio_bdf:-EDIT_ME}"

GPU_VENDOR_ID="$gpu_vendor"
GPU_DEVICE_ID="$gpu_device"
GPU_AUDIO_VENDOR_ID="${audio_vendor:-$gpu_vendor}"
GPU_AUDIO_DEVICE_ID="${audio_device:-EDIT_ME}"

# â”€â”€ ISO Paths â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

WIN_ISO_PATH="${win_iso:-/path/to/Win11.iso}"
VIRTIO_ISO_PATH="${virtio_iso:-/path/to/virtio-win.iso}"

# â”€â”€ Hardware Health â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

DRAGONFORGE_HOOK_TIMEOUT="30"
DRAGONFORGE_GPU_TEMP_MAX="85"
CONFEOF

    success "Config written to config/dragonforge.conf"

    # Report what was detected vs what needs manual editing
    if [ -n "$win_iso" ]; then
        success "Windows ISO: $win_iso"
    else
        warn "No Windows ISO found â€” edit WIN_ISO_PATH in config"
    fi
    if [ -n "$virtio_iso" ]; then
        success "VirtIO ISO: $virtio_iso"
    else
        warn "No VirtIO ISO found â€” edit VIRTIO_ISO_PATH in config"
    fi

    echo ""
    return 0
}

# â”€â”€ Load Config Helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

load_config() {
    local conf="$SCRIPT_DIR/config/dragonforge.conf"

    # Auto-generate if missing
    if [ ! -f "$conf" ]; then
        auto_generate_config || {
            error "Cannot proceed without config"
            exit 1
        }
    fi

    source "$conf"
}

# â”€â”€ Detect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_detect() {
    print_banner
    header "System Information"

    # OS
    if [ -f /etc/os-release ]; then
        source /etc/os-release
        info "OS: ${BOLD}$NAME $VERSION${NC}"
    fi

    # Kernel
    info "Kernel: ${BOLD}$(uname -r)${NC}"

    # CPU
    local cpu_model
    cpu_model=$(grep -m1 "model name" /proc/cpuinfo | cut -d: -f2 | xargs)
    info "CPU: ${BOLD}$cpu_model${NC}"

    # RAM
    local total_ram
    total_ram=$(free -h | awk '/Mem:/{print $2}')
    info "RAM: ${BOLD}$total_ram${NC}"

    # QEMU
    if command -v qemu-system-x86_64 &>/dev/null; then
        local qemu_ver
        qemu_ver=$(qemu-system-x86_64 --version | head -1 | grep -oP '\d+\.\d+(\.\d+)?' | head -1)
        success "QEMU: $qemu_ver"
    else
        error "QEMU not found"
    fi

    # Libvirt
    if command -v virsh &>/dev/null; then
        local virsh_ver
        virsh_ver=$(virsh --version)
        success "Libvirt: $virsh_ver"
    else
        error "Libvirt not found"
    fi

    # virt-viewer
    if command -v virt-viewer &>/dev/null; then
        success "virt-viewer: installed"
    else
        warn "virt-viewer: not found (install for SPICE display)"
    fi

    # IOMMU
    header "IOMMU Status"

    # Check sysfs first (doesn't need root), then dmesg as fallback
    if [ -d /sys/class/iommu ] && [ -n "$(ls -A /sys/class/iommu 2>/dev/null)" ]; then
        success "IOMMU is enabled"
        local group_count
        group_count=$(find /sys/kernel/iommu_groups -maxdepth 1 -mindepth 1 -type d 2>/dev/null | wc -l)
        info "IOMMU groups found: ${BOLD}$group_count${NC}"
    elif dmesg 2>/dev/null | grep -qi "IOMMU enabled\|DMAR:.*IOMMU\|Adding to iommu group"; then
        success "IOMMU is enabled (detected via dmesg)"
    else
        error "IOMMU does not appear to be enabled"
        info "Add 'intel_iommu=on iommu=pt' (Intel) or 'amd_iommu=on iommu=pt' (AMD) to kernel params"
    fi

    # VFIO modules
    header "VFIO Modules"

    for mod in vfio vfio_pci vfio_iommu_type1; do
        if lsmod | grep -q "^${mod//-/_}"; then
            success "$mod: loaded"
        else
            warn "$mod: not loaded"
        fi
    done

    # GPU detection
    header "GPU Devices"

    echo -e "  ${DIM}Scanning for NVIDIA/AMD discrete GPUs...${NC}"
    echo ""

    local gpu_found=0
    while IFS= read -r line; do
        local bdf desc
        bdf=$(echo "$line" | awk '{print $1}')
        desc=$(echo "$line" | cut -d' ' -f2-)

        if echo "$desc" | grep -qiE "nvidia|radeon|amd.*navi|amd.*vega"; then
            # bdf may include domain (e.g. 0000:01:00.0) or not (01:00.0)
            # sysfs always uses the full domain:bus:slot.function format
            local sysfs_bdf="$bdf"
            if [[ ! "$bdf" =~ ^[0-9a-fA-F]{4}: ]]; then
                sysfs_bdf="0000:$bdf"
            fi

            local vendor_id device_id
            vendor_id=$(cat "/sys/bus/pci/devices/$sysfs_bdf/vendor" 2>/dev/null | sed 's/^0x//')
            device_id=$(cat "/sys/bus/pci/devices/$sysfs_bdf/device" 2>/dev/null | sed 's/^0x//')

            echo -e "  ${GREEN}â–º${NC} ${BOLD}$bdf${NC}"
            echo -e "    $desc"
            echo -e "    ${DIM}Vendor:Device = $vendor_id:$device_id${NC}"

            # IOMMU group
            local iommu_group
            iommu_group=$(basename "$(readlink "/sys/bus/pci/devices/$sysfs_bdf/iommu_group" 2>/dev/null)" 2>/dev/null)
            if [ -n "$iommu_group" ]; then
                echo -e "    ${DIM}IOMMU Group: $iommu_group${NC}"

                # List other devices in same group
                local group_members
                group_members=$(find "/sys/kernel/iommu_groups/$iommu_group/devices/" -maxdepth 1 -mindepth 1 -printf '%f ' 2>/dev/null)
                echo -e "    ${DIM}Group members: $group_members${NC}"
            fi

            # Current driver
            local driver
            driver=$(basename "$(readlink "/sys/bus/pci/devices/$sysfs_bdf/driver" 2>/dev/null)" 2>/dev/null)
            echo -e "    ${DIM}Driver: ${driver:-none}${NC}"

            echo ""
            gpu_found=1
        fi
    done < <(lspci -Dnn 2>/dev/null | grep -iE "VGA|3D|Display|Audio" || true)

    if [ "$gpu_found" -eq 0 ]; then
        warn "No discrete GPU found"
    fi

    # Summary
    header "Next Steps"
    info "Run ${BOLD}dragonforge setup${NC} â€” config is auto-generated from detected hardware"
    info "Then ${BOLD}dragonforge create${NC} to create the VM"
    info "Edit ${BOLD}config/dragonforge.conf${NC} if you need to tweak anything"
    echo ""
}

# â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_status() {
    print_banner
    header "DragonForge Status"

    # Load config (auto-generates if missing)
    load_config

    local vm_name="${VM_NAME:-win11-dragonforge}"
    local gpu_pci="${GPU_PCI:-0000:01:00.0}"
    local gpu_audio="${GPU_AUDIO:-0000:01:00.1}"

    info "VM Name: ${BOLD}$vm_name${NC}"
    info "GPU PCI: ${BOLD}$gpu_pci${NC}"
    info "GPU Audio: ${BOLD}$gpu_audio${NC}"

    # VM state
    header "VM State"
    local vm_state
    vm_state=$(sudo virsh domstate "$vm_name" 2>/dev/null | head -1 || echo "undefined")
    vm_state=$(echo "$vm_state" | tr -d '[:space:]')  # trim whitespace
    if [ -z "$vm_state" ]; then vm_state="undefined"; fi

    if [ "$vm_state" = "running" ]; then
        success "VM is running"
    elif [ "$vm_state" = "shutoff" ]; then
        info "VM is shut off"
    elif [ "$vm_state" = "undefined" ]; then
        warn "VM not created yet â€” run './dragonforge vm-create'"
    else
        warn "VM state: $vm_state"
    fi

    # GPU driver
    header "GPU Driver State"
    for dev in $gpu_pci $gpu_audio; do
        local driver
        driver=$(basename "$(readlink "/sys/bus/pci/devices/$dev/driver" 2>/dev/null)" 2>/dev/null)
        if [ "$driver" = "vfio-pci" ]; then
            info "$dev â†’ ${YELLOW}vfio-pci${NC} (passthrough mode)"
        elif [ -n "$driver" ]; then
            info "$dev â†’ ${GREEN}$driver${NC} (host mode)"
        else
            warn "$dev â†’ no driver"
        fi
    done

    # Hook installed?
    header "Installation"
    if sudo test -x /etc/libvirt/hooks/qemu 2>/dev/null; then
        success "Hook installed at /etc/libvirt/hooks/qemu"
    else
        warn "Hook not installed"
    fi

    if [ -f /etc/modules-load.d/dragonforge-vfio.conf ] || [ -f /etc/modules-load.d/vfio.conf ]; then
        success "VFIO modules configured for boot"
    else
        warn "VFIO module autoload not configured"
    fi

    echo ""
}

# â”€â”€ Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_setup() {
    print_banner
    header "Installing DragonForge"

    # Check root
    if [ "$EUID" -ne 0 ]; then
        error "Setup must be run as root (use sudo)"
        exit 1
    fi

    # Load config (auto-generates if missing)
    load_config

    # Validate config
    if [ -z "${GPU_PCI:-}" ] || [ -z "${GPU_AUDIO:-}" ] || [ -z "${GPU_VENDOR_ID:-}" ] || [ -z "${GPU_DEVICE_ID:-}" ]; then
        error "Incomplete config. Required: GPU_PCI, GPU_AUDIO, GPU_VENDOR_ID, GPU_DEVICE_ID"
        exit 1
    fi

    # Install hook
    info "Installing libvirt hook..."
    local hook_src="$SCRIPT_DIR/hooks/qemu"
    if [ ! -f "$hook_src" ]; then
        error "Hook script not found: $hook_src"
        exit 1
    fi

    mkdir -p /etc/libvirt/hooks
    cp "$hook_src" /etc/libvirt/hooks/qemu
    chmod +x /etc/libvirt/hooks/qemu
    success "Hook installed"

    # Set up environment for hook (so it reads our config)
    cat > /etc/libvirt/hooks/dragonforge.env <<ENVEOF
# DragonForge GPU passthrough config â€” auto-generated
DRAGONFORGE_VM_NAME=$VM_NAME
DRAGONFORGE_GPU_PCI=$GPU_PCI
DRAGONFORGE_GPU_AUDIO=$GPU_AUDIO
ENVEOF
    success "Hook environment configured"

    # Patch hook to source env file
    if ! grep -q "dragonforge.env" /etc/libvirt/hooks/qemu; then
        sed -i '2i\\n# Source DragonForge config\nif [ -f /etc/libvirt/hooks/dragonforge.env ]; then source /etc/libvirt/hooks/dragonforge.env; fi' /etc/libvirt/hooks/qemu
    fi

    # VFIO module autoload
    info "Configuring VFIO modules for boot..."
    cat > /etc/modules-load.d/dragonforge-vfio.conf <<EOF
# DragonForge â€” VFIO modules for GPU passthrough
vfio-pci
vfio
vfio_iommu_type1
EOF
    success "VFIO modules will load at boot"

    # VFIO PCI IDs + softdep
    info "Configuring VFIO PCI device binding..."
    local audio_vendor_id="${GPU_AUDIO_VENDOR_ID:-$GPU_VENDOR_ID}"
    local audio_device_id="${GPU_AUDIO_DEVICE_ID:-22be}"
    cat > /etc/modprobe.d/dragonforge-vfio.conf <<EOF
# DragonForge â€” Bind GPU to vfio-pci at boot
options vfio-pci ids=$GPU_VENDOR_ID:$GPU_DEVICE_ID,$audio_vendor_id:$audio_device_id
softdep nvidia pre: vfio-pci
softdep nouveau pre: vfio-pci
EOF
    success "VFIO PCI binding configured"

    # Ensure required packages
    header "Checking Dependencies"
    local deps_ok=1
    for cmd in qemu-system-x86_64 virsh virt-viewer swtpm; do
        if command -v "$cmd" &>/dev/null; then
            success "$cmd: found"
        else
            warn "$cmd: not found"
            deps_ok=0
        fi
    done

    if [ "$deps_ok" -eq 0 ]; then
        echo ""
        info "Install missing packages:"
        info "  Fedora:  sudo dnf install qemu-kvm libvirt virt-manager virt-viewer swtpm"
        info "  Arch:    sudo pacman -S qemu-full libvirt virt-manager virt-viewer swtpm"
        info "  Ubuntu:  sudo apt install qemu-kvm libvirt-daemon virt-manager virt-viewer swtpm"
    fi

    # Create symlink so 'dragonforge' works from anywhere
    local symlink_target="/usr/local/bin/dragonforge"
    local script_path
    script_path=$(realpath "$SCRIPT_DIR/dragonforge")
    if [ -L "$symlink_target" ] || [ -e "$symlink_target" ]; then
        rm -f "$symlink_target"
    fi
    ln -s "$script_path" "$symlink_target"
    success "Symlink: dragonforge â†’ $script_path"

    # Restart libvirtd
    info "Restarting libvirtd..."
    systemctl restart libvirtd
    success "libvirtd restarted"

    header "Setup Complete"
    success "DragonForge is installed"
    info "You can now run ${BOLD}dragonforge${NC} from anywhere"
    info "Reboot to apply VFIO module changes, then run:"
    info "  ${BOLD}dragonforge create${NC}  â€” Create a Windows VM"
    info "  ${BOLD}dragonforge start${NC}   â€” Start the VM"
    echo ""
}

# â”€â”€ VM Create â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_vm_create() {
    print_banner
    header "Creating VM"

    # Load config (auto-generates if missing)
    load_config

    local vm_name="${VM_NAME:-win11-dragonforge}"
    local vm_ram="${VM_RAM_MB:-16384}"
    local vm_cpus="${VM_CPUS:-8}"
    local disk_size="${VM_DISK_SIZE:-128G}"
    local disk_path="${VM_DISK_PATH:-/var/lib/libvirt/images/${vm_name}.qcow2}"
    local win_iso="${WIN_ISO_PATH:-}"
    local virtio_iso="${VIRTIO_ISO_PATH:-}"

    # Validate
    if [ -z "$win_iso" ] || [ ! -f "$win_iso" ]; then
        error "Windows ISO not found: $win_iso"
        info "Set WIN_ISO_PATH in config/dragonforge.conf"
        exit 1
    fi

    if [ -z "$virtio_iso" ] || [ ! -f "$virtio_iso" ]; then
        warn "VirtIO ISO not found. Download from:"
        info "https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso"
    fi

    # Create disk
    if [ ! -f "$disk_path" ]; then
        info "Creating ${disk_size} qcow2 disk..."
        sudo qemu-img create -f qcow2 "$disk_path" "$disk_size"
        success "Disk created: $disk_path"
    else
        warn "Disk already exists: $disk_path"
    fi

    # Copy OVMF VARS for secure boot (always fresh â€” stale VARS breaks TPM/SecureBoot)
    local ovmf_vars="/var/lib/libvirt/images/${vm_name}_VARS.fd"
    local ovmf_src=""
    for candidate in \
        /usr/share/edk2/ovmf/OVMF_VARS.secboot.fd \
        /usr/share/OVMF/OVMF_VARS.ms.fd \
        /usr/share/OVMF/OVMF_VARS.fd \
        /usr/share/edk2/ovmf/OVMF_VARS.fd; do
        if [ -f "$candidate" ]; then
            ovmf_src="$candidate"
            break
        fi
    done
    if [ -n "$ovmf_src" ]; then
        sudo cp "$ovmf_src" "$ovmf_vars"
        success "OVMF VARS: $ovmf_vars (fresh copy)"
    else
        error "No OVMF VARS template found. Install edk2-ovmf."
        exit 1
    fi

    # Find OVMF CODE
    local ovmf_code=""
    for candidate in \
        /usr/share/edk2/ovmf/OVMF_CODE.secboot.fd \
        /usr/share/OVMF/OVMF_CODE.secboot.fd \
        /usr/share/OVMF/OVMF_CODE.ms.fd \
        /usr/share/edk2/ovmf/OVMF_CODE.fd \
        /usr/share/OVMF/OVMF_CODE.fd; do
        if [ -f "$candidate" ]; then
            ovmf_code="$candidate"
            break
        fi
    done

    if [ -z "$ovmf_code" ]; then
        error "No OVMF CODE found. Install edk2-ovmf."
        exit 1
    fi

    # Helper to parse PCI address (domain:bus:slot.function) into XML
    pci_hostdev_xml() {
        local pci_addr="$1"
        local guest_fn="${2:-0}"
        local multifunction="${3:-}"
        # Parse: 0000:01:00.0 â†’ domain=0000, bus=01, slot=00, function=0
        local domain bus slot function
        domain=$(echo "$pci_addr" | cut -d: -f1)
        bus=$(echo "$pci_addr" | cut -d: -f2)
        slot=$(echo "$pci_addr" | cut -d: -f3 | cut -d. -f1)
        function=$(echo "$pci_addr" | cut -d. -f2)

        local mf_attr=""
        if [ -n "$multifunction" ]; then
            mf_attr=" multifunction='on'"
        fi

        cat <<PCIEOF
    <hostdev mode='subsystem' type='pci' managed='yes'>
      <source>
        <address domain='0x${domain}' bus='0x${bus}' slot='0x${slot}' function='0x${function}'/>
      </source>
      <address type='pci' domain='0x0000' bus='0x06' slot='0x00' function='0x${guest_fn}'${mf_attr}/>
    </hostdev>
PCIEOF
    }

    # Generate VM XML
    info "Generating VM definition..."

    local xml_path
    xml_path=$(mktemp "/tmp/${vm_name}.XXXXXX.xml")
    cat > "$xml_path" <<XMLEOF
<domain type='kvm'>
  <name>$vm_name</name>
  <metadata>
    <dragonforge:vm xmlns:dragonforge="https://github.com/Ghosts-Protocol-Pvt-Ltd/DragonForge">
      <dragonforge:version>1.0.0</dragonforge:version>
    </dragonforge:vm>
  </metadata>
  <memory unit='MiB'>$vm_ram</memory>
  <currentMemory unit='MiB'>$vm_ram</currentMemory>
  <vcpu placement='static'>$vm_cpus</vcpu>
  <iothreads>1</iothreads>
  <os>
    <type arch='x86_64' machine='q35'>hvm</type>
    <loader readonly='yes' secure='yes' type='pflash'>$ovmf_code</loader>
    <nvram>$ovmf_vars</nvram>
    <boot dev='cdrom'/>
    <boot dev='hd'/>
    <smbios mode='host'/>
  </os>
  <features>
    <acpi/>
    <apic/>
    <hyperv mode='custom'>
      <relaxed state='on'/>
      <vapic state='on'/>
      <spinlocks state='on' retries='8191'/>
      <vpindex state='on'/>
      <runtime state='on'/>
      <synic state='on'/>
      <stimer state='on'/>
      <frequencies state='on'/>
      <vendor_id state='on' value='GenuineIntel'/>
    </hyperv>
    <kvm>
      <hidden state='on'/>
    </kvm>
    <vmport state='off'/>
    <smm state='on'/>
  </features>
  <cpu mode='host-passthrough' check='none' migratable='off'>
    <topology sockets='1' dies='1' clusters='1' cores='$(( vm_cpus > 1 ? vm_cpus / 2 : 1 ))' threads='$(( vm_cpus > 1 ? 2 : 1 ))'/>
  </cpu>
  <clock offset='localtime'>
    <timer name='rtc' tickpolicy='catchup'/>
    <timer name='pit' tickpolicy='delay'/>
    <timer name='hpet' present='no'/>
    <timer name='hypervclock' present='yes'/>
  </clock>
  <on_poweroff>destroy</on_poweroff>
  <on_reboot>restart</on_reboot>
  <on_crash>destroy</on_crash>
  <pm>
    <suspend-to-mem enabled='no'/>
    <suspend-to-disk enabled='no'/>
  </pm>
  <devices>
    <emulator>/usr/bin/qemu-system-x86_64</emulator>

    <!-- VirtIO Disk -->
    <disk type='file' device='disk'>
      <driver name='qemu' type='qcow2' cache='writeback' io='threads' discard='unmap' iothread='1' queues='4'/>
      <source file='$disk_path'/>
      <target dev='vda' bus='virtio'/>
    </disk>

    <!-- Windows ISO -->
    <disk type='file' device='cdrom'>
      <driver name='qemu' type='raw'/>
      <source file='$win_iso'/>
      <target dev='sda' bus='sata'/>
      <readonly/>
    </disk>

    <!-- VirtIO Drivers ISO -->
$(if [ -n "$virtio_iso" ] && [ -f "$virtio_iso" ]; then
    echo "    <disk type='file' device='cdrom'>"
    echo "      <driver name='qemu' type='raw'/>"
    echo "      <source file='$virtio_iso'/>"
    echo "      <target dev='sdb' bus='sata'/>"
    echo "      <readonly/>"
    echo "    </disk>"
fi)

    <!-- Network -->
    <interface type='network'>
      <source network='default'/>
      <model type='virtio'/>
    </interface>

    <!-- SPICE Display (for initial setup) -->
    <graphics type='spice' autoport='yes' listen='127.0.0.1'>
      <listen type='address' address='127.0.0.1'/>
    </graphics>
    <video>
      <model type='qxl' ram='65536' vram='65536' vgamem='16384' heads='1' primary='yes'/>
    </video>

    <!-- USB Controller -->
    <controller type='usb' model='qemu-xhci' ports='8'/>
    <input type='tablet' bus='usb'/>
    <input type='keyboard' bus='usb'/>

    <!-- TPM 2.0 (for Windows 11 â€” must use tpm-crb, not tpm-tis) -->
    <tpm model='tpm-crb'>
      <backend type='emulator' version='2.0'/>
    </tpm>

    <!-- GPU Passthrough -->
$(pci_hostdev_xml "$GPU_PCI" 0 on)
$(pci_hostdev_xml "$GPU_AUDIO" 1)

    <!-- Audio (through SPICE) -->
    <sound model='ich9'>
      <audio id='1'/>
    </sound>
    <audio id='1' type='spice'/>

    <!-- Balloon -->
    <memballoon model='virtio'/>

    <!-- RNG -->
    <rng model='virtio'>
      <backend model='random'>/dev/urandom</backend>
    </rng>
  </devices>
</domain>
XMLEOF

    success "VM XML generated: $xml_path"

    # Define in libvirt
    info "Defining VM in libvirt..."
    if sudo virsh dominfo "$vm_name" &>/dev/null; then
        # Stop if running
        local cur_state
        cur_state=$(sudo virsh domstate "$vm_name" 2>/dev/null || true)
        if [ "$cur_state" = "running" ] || [ "$cur_state" = "paused" ]; then
            warn "VM is $cur_state â€” destroying first"
            sudo virsh destroy "$vm_name" 2>/dev/null || true
            sleep 1
        fi
        warn "VM '$vm_name' already defined â€” undefining (with NVRAM + TPM cleanup)"
        sudo virsh undefine "$vm_name" --nvram --tpm 2>/dev/null || true
    fi

    # Also nuke any leftover swtpm state (ensures clean TPM on next boot)
    local swtpm_dir="/var/lib/libvirt/swtpm"
    if [ -d "$swtpm_dir" ]; then
        # Find and remove state dirs for this VM name (match by path contents)
        for uuid_dir in "$swtpm_dir"/*/; do
            [ -d "$uuid_dir" ] && sudo rm -rf "$uuid_dir"
        done
        info "Cleared swtpm state for fresh TPM"
    fi

    sudo virsh define "$xml_path"
    rm -f "$xml_path"
    success "VM defined: $vm_name"

    header "VM Created"
    info "Start with:  ${BOLD}./dragonforge vm-start${NC}"
    info "View with:   ${BOLD}./dragonforge vm-viewer${NC}"
    echo ""
}

# â”€â”€ VM Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_vm_start() {
    load_config
    local vm_name="${VM_NAME:-win11-dragonforge}"
    local gpu_pci="${GPU_PCI:-0000:01:00.0}"

    print_banner
    header "Starting VM"

    # Pre-flight checks
    if ! lsmod | grep -q "^vfio_pci"; then
        error "vfio_pci module not loaded"
        info "Run: sudo modprobe vfio-pci"
        info "Or reboot after running './dragonforge setup'"
        exit 1
    fi
    success "vfio_pci module loaded"

    # Check if VM is already running
    local state
    state=$(sudo virsh domstate "$vm_name" 2>/dev/null || echo "undefined")
    if [ "$state" = "running" ]; then
        warn "$vm_name is already running"
        info "Use './dragonforge vm-viewer' to connect"
        return 0
    fi

    # Check if GPU exists at PCI address
    if [ ! -d "/sys/bus/pci/devices/$gpu_pci" ]; then
        error "GPU not found at PCI address $gpu_pci"
        info "Run './dragonforge detect' to find the correct address"
        exit 1
    fi
    success "GPU found at $gpu_pci"

    # GPU temperature check
    if command -v nvidia-smi &>/dev/null; then
        local temp
        temp=$(nvidia-smi --query-gpu=temperature.gpu --format=csv,noheader,nounits 2>/dev/null | head -1)
        if [ -n "$temp" ] && [ "$temp" -gt 0 ] 2>/dev/null; then
            local temp_max="${DRAGONFORGE_GPU_TEMP_MAX:-85}"
            if [ "$temp" -ge "$temp_max" ]; then
                error "GPU temperature ${temp}Â°C exceeds safe limit ${temp_max}Â°C"
                info "Let the GPU cool down before starting the VM"
                exit 1
            fi
            success "GPU temperature: ${temp}Â°C (limit: ${temp_max}Â°C)"
        fi
    fi

    # Battery check for laptops
    local bat_path="/sys/class/power_supply/BAT0"
    if [ -d "$bat_path" ]; then
        local ac_status
        ac_status=$(cat /sys/class/power_supply/AC*/online 2>/dev/null | head -1)
        if [ "${ac_status:-1}" = "0" ]; then
            local capacity
            capacity=$(cat "$bat_path/capacity" 2>/dev/null || echo "unknown")
            warn "Running on battery (${capacity}%) â€” GPU passthrough drains battery fast"
            info "Plug in power for best experience"
        else
            success "AC power connected"
        fi
    fi

    # Check libvirtd is running
    if ! systemctl is-active --quiet libvirtd 2>/dev/null; then
        error "libvirtd is not running"
        info "Run: sudo systemctl start libvirtd"
        exit 1
    fi
    success "libvirtd is running"

    info "Starting $vm_name..."
    sudo virsh start "$vm_name"
    success "$vm_name is running"

    echo ""
    info "Open viewer: ${BOLD}./dragonforge vm-viewer${NC}"
    info "Stop VM:     ${BOLD}./dragonforge vm-stop${NC}"
    echo ""
}

# â”€â”€ VM Stop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_vm_stop() {
    load_config
    local vm_name="${VM_NAME:-win11-dragonforge}"
    local gpu_pci="${GPU_PCI:-0000:01:00.0}"

    # Check if VM is actually running
    local state
    state=$(sudo virsh domstate "$vm_name" 2>/dev/null || echo "undefined")
    if [ "$state" != "running" ]; then
        info "$vm_name is not running (state: $state)"
        return 0
    fi

    info "Shutting down $vm_name..."
    sudo virsh shutdown "$vm_name"
    info "Waiting for graceful shutdown (60s timeout)..."

    local i=0
    while [ "$i" -lt 60 ]; do
        if ! sudo virsh domstate "$vm_name" 2>/dev/null | grep -q "running"; then
            success "$vm_name has shut down"

            # Verify GPU returned to host
            sleep 3
            local driver
            driver=$(basename "$(readlink "/sys/bus/pci/devices/$gpu_pci/driver" 2>/dev/null)" 2>/dev/null)
            if [ -n "$driver" ] && [ "$driver" != "vfio-pci" ]; then
                success "GPU returned to host ($driver)"
            elif [ "$driver" = "vfio-pci" ]; then
                warn "GPU still on vfio-pci â€” hook release may have failed"
                info "Run: sudo dragonforge reset"
            else
                warn "GPU has no driver â€” may need PCI rescan"
                info "Run: sudo dragonforge reset"
            fi
            return 0
        fi
        sleep 1
        i=$((i + 1))
    done

    warn "VM did not shut down gracefully after 60s."
    info "Use './dragonforge vm-kill' to force stop."
}

# â”€â”€ VM Kill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_vm_kill() {
    load_config
    local vm_name="${VM_NAME:-win11-dragonforge}"

    # Check if running first
    local state
    state=$(sudo virsh domstate "$vm_name" 2>/dev/null || echo "undefined")
    if [ "$state" != "running" ] && [ "$state" != "paused" ]; then
        info "$vm_name is not running (state: $state)"
        return 0
    fi

    warn "Force stopping $vm_name..."
    sudo virsh destroy "$vm_name"
    success "$vm_name forcefully stopped"
    info "GPU should return to host within a few seconds"
}

# â”€â”€ VM Viewer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_vm_viewer() {
    load_config
    local vm_name="${VM_NAME:-win11-dragonforge}"

    # Check if VM is running
    local state
    state=$(sudo virsh domstate "$vm_name" 2>/dev/null || echo "undefined")
    if [ "$state" != "running" ]; then
        error "$vm_name is not running (state: $state)"
        info "Start it first: ./dragonforge vm-start"
        exit 1
    fi

    if ! command -v virt-viewer &>/dev/null; then
        error "virt-viewer not installed"
        info "Install: sudo dnf install virt-viewer"
        exit 1
    fi

    info "Opening SPICE viewer for $vm_name..."
    virt-viewer "$vm_name" &
    disown
    success "Viewer opened"
}

# â”€â”€ GPU Reset (emergency) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_gpu_reset() {
    print_banner
    header "Emergency GPU Reset"

    load_config
    local gpu_pci="${GPU_PCI:-0000:01:00.0}"
    local gpu_audio="${GPU_AUDIO:-0000:01:00.1}"

    if [ "$EUID" -ne 0 ]; then
        error "GPU reset must be run as root (use sudo)"
        exit 1
    fi

    for dev in $gpu_pci $gpu_audio; do
        local driver
        driver=$(basename "$(readlink "/sys/bus/pci/devices/$dev/driver" 2>/dev/null)" 2>/dev/null)
        info "$dev current driver: ${driver:-none}"

        # Unbind from current driver
        if [ -n "$driver" ]; then
            echo "$dev" > "/sys/bus/pci/devices/$dev/driver/unbind" 2>/dev/null || true
            sleep 0.5
        fi

        # Clear override
        echo "" > "/sys/bus/pci/devices/$dev/driver_override" 2>/dev/null || true
    done

    # Rescan PCI bus
    info "Rescanning PCI bus..."
    echo 1 > /sys/bus/pci/rescan
    sleep 2

    # Reload nvidia
    for mod in nvidia nvidia_modeset nvidia_uvm nvidia_drm; do
        modprobe "$mod" 2>/dev/null || true
    done

    # Verify
    for dev in $gpu_pci $gpu_audio; do
        local driver
        driver=$(basename "$(readlink "/sys/bus/pci/devices/$dev/driver" 2>/dev/null)" 2>/dev/null)
        if [ -n "$driver" ] && [ "$driver" != "vfio-pci" ]; then
            success "$dev â†’ $driver"
        else
            warn "$dev â†’ ${driver:-no driver}"
        fi
    done

    echo ""
}

# â”€â”€ Logs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_logs() {
    local log_file="/var/log/dragonforge.log"
    local lines="${1:-50}"

    if [ -f "$log_file" ]; then
        info "Last $lines lines from $log_file:"
        echo ""
        tail -n "$lines" "$log_file"
    else
        info "No log file yet. Logs are created when the VM starts/stops."
    fi

    echo ""
    info "System journal entries:"
    echo ""
    journalctl -t DragonForge --no-pager -n "$lines" 2>/dev/null || info "No journal entries found"
    echo ""
}

# â”€â”€ Uninstall â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_uninstall() {
    print_banner
    header "Uninstalling DragonForge"

    if [ "$EUID" -ne 0 ]; then
        error "Uninstall must be run as root (use sudo)"
        exit 1
    fi

    rm -f /etc/libvirt/hooks/qemu
    rm -f /etc/libvirt/hooks/dragonforge.env
    rm -f /etc/modules-load.d/dragonforge-vfio.conf
    rm -f /etc/modprobe.d/dragonforge-vfio.conf
    rm -f /usr/local/bin/dragonforge

    success "Hook removed"
    success "VFIO configs removed"
    success "Symlink removed"
    info "Reboot to fully revert changes"
    echo ""
}

# â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Normalize command: strip hyphens so "vmstart" = "vm-start"
CMD=$(echo "${1:-help}" | tr -d '-')

case "$CMD" in
    detect)                 cmd_detect ;;
    setup|install)          cmd_setup ;;
    status)                 cmd_status ;;
    vmcreate|create)        cmd_vm_create ;;
    vmstart|start)          cmd_vm_start ;;
    vmstop|stop)            cmd_vm_stop ;;
    vmkill|kill)            cmd_vm_kill ;;
    vmviewer|viewer)        cmd_vm_viewer ;;
    gpureset|reset)         cmd_gpu_reset ;;
    logs|log)               cmd_logs "${2:-}" ;;
    uninstall|remove)       cmd_uninstall ;;
    help|*)
        print_banner
        echo "  Usage: dragonforge <command>"
        echo ""
        echo "  Commands:"
        echo "    detect      Detect GPU, IOMMU groups, system info"
        echo "    setup       Install hook + configure VFIO (requires sudo)"
        echo "    status      Check passthrough state"
        echo "    create      Create Windows 11 VM from config"
        echo "    start       Start the VM (with pre-flight checks)"
        echo "    stop        Gracefully shut down the VM"
        echo "    kill        Force stop the VM"
        echo "    viewer      Open SPICE viewer"
        echo "    reset       Emergency: return GPU to host (requires sudo)"
        echo "    logs        Show DragonForge log history"
        echo "    uninstall   Remove hook and VFIO config (requires sudo)"
        echo ""
        echo "  Aliases: vm-start, vmstart, start all work. Hyphens are optional."
        echo ""
        ;;
esac
